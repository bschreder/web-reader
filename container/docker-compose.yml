name: web-reader

services:
  ollama:
    image: ollama/ollama:latest
    container_name: ws-ollama
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=24h
      - OLLAMA_NUM_PARALLEL=1
      - OLLAMA_MAX_QUEUE=2
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:8b}
      - OLLAMA_CONTEXT_LENGTH=${OLLAMA_CONTEXT_LENGTH:-131072}
    ports:
      - '11434:11434'
    volumes:
      - ollama:/root/.ollama
    healthcheck:
      test: ['CMD', 'bash', '-lc', '(echo > /dev/tcp/127.0.0.1/11434) >/dev/null 2>&1']
      interval: 10s
      timeout: 5s
      retries: 10

  browser:
    image: mcr.microsoft.com/playwright:v1.56.1-noble
    container_name: ws-playwright
    restart: unless-stopped
    init: true
    ipc: host
    user: pwuser
    command: ['/bin/sh', '-lc', 'npx -y playwright@1.56.1 run-server --port 3002 --host 0.0.0.0']
    ports:
      - '3002:3002'
    shm_size: 1gb
    healthcheck:
      test: ['CMD', 'bash', '-lc', '(echo > /dev/tcp/127.0.0.1/3002) >/dev/null 2>&1']
      interval: 10s
      timeout: 5s
      retries: 10

  model-loader:
    image: curlimages/curl:latest
    container_name: ws-ollama-model-loader
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:8b}
    entrypoint: ['/bin/sh', '-c']
    command: >-
      "
      echo 'Waiting for Ollama...';
      until curl -sf http://ollama:11434/api/version >/dev/null; do sleep 2; done;
      echo 'Pulling model '"$${OLLAMA_MODEL}"'...';
        curl -s -X POST http://ollama:11434/api/pull -H 'content-type: application/json' -d '{\"name\":\"'"$${OLLAMA_MODEL}"'\"}' || true;
      echo 'Model pull requested.'
      "

volumes:
  ollama:
    driver: local
